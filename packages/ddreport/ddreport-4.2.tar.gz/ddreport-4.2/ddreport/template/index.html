<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.2.36/index.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.45/vue.global.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.2.36/index.full.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <title>测试报告</title>
</head>
<style>
    body {
        margin: 0;
        width: 100%;
        height: 100%;
    }

    pre {
        border: 1px solid #dedede;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0 20px;
        padding: 10px;
    }

    .title {
        text-align: center;
        font-weight: bolder;
        background-color: #42b983;
        margin: 0;
        padding: 20px;
        color: #4b4b4b;
    }

    .card-header span {
        font-size: 13px;
        margin-right: 10px;
    }

    .card-header .el-select {
        margin-right: 40px;
    }

    .row-expand {
        background-color: #f5f5f5;
        padding: 10px;
    }

    .block {
        padding: 30px 0;
        text-align: center;
        border-right: solid 1px #E9EBF0;
        display: inline-block;
        width: 49%;
        box-sizing: border-box;
        vertical-align: top;
    }


</style>
<body>
<div id="app">
    <el-scrollbar height="100vh">
        <el-backtop target="#app  .el-scrollbar__wrap"></el-backtop>
        <h2 class="title">{{sourceData.title}}</h2>
        <el-row style="margin: 10px;">
            <el-col :span="20" :push="2">
                <el-card>
                    <template #header>
                        <el-row>
                            <el-col :span="12">
                                <span style="font-weight: bolder; line-height: 32px">报告概览</span>
                            </el-col>
                        </el-row>
                    </template>
                    <el-row :gutter="50">
                        <el-col :span="6" style="border-right: 1px solid rgba(228,231,237,0.82)">
                            <el-form :model="form" label-width="100px">
                                <el-form-item label="报告名称">
                                    <el-input readonly v-model="sourceData.desc"/>
                                </el-form-item>
                                <el-form-item>
                                    <template #label>
                                        <span style="color: #0f9165">成功总数</span>
                                    </template>
                                    <el-input readonly v-model="sourceData.passed"/>
                                </el-form-item>
                                <el-form-item>
                                    <template #label>
                                        <span style="color: #94303f">失败总数</span>
                                    </template>
                                    <el-input readonly v-model="sourceData.failed"/>
                                </el-form-item>
                                <el-form-item>
                                    <template #label>
                                        <span style="color: #636363">跳过总数</span>
                                    </template>
                                    <el-input readonly v-model="sourceData.skipped"/>
                                </el-form-item>
                                <el-form-item>
                                    <template #label>
                                        <span style="color: #e6a23c">错误总数</span>
                                    </template>
                                    <el-input readonly v-model="sourceData.error"/>
                                </el-form-item>
                                <el-form-item label="开始时间">
                                    <el-input readonly v-model="sourceData.start_time"/>
                                </el-form-item>
                                <el-form-item label="结束时间">
                                    <el-input readonly v-model="sourceData.end_time"/>
                                </el-form-item>
                                <el-form-item label="测试人员">
                                    <el-input readonly v-model="sourceData.tester"/>
                                </el-form-item>
                            </el-form>
                        </el-col>
                        <el-col :span="7" style="border-right: 1px solid rgba(228,231,237,0.82)">
                            <div id="echart1" :style="{height: '300px'}"></div>
                        </el-col>
                        <el-col :span="11">
                            <div id="echart2" :style="{height: '300px'}"></div>
                        </el-col>
                    </el-row>
                </el-card>
                <br/>
                <!-- table详情 ---------------->
                <el-card>
                    <template #header>
                        <el-row class="card-header">
                            <el-col :span="20">
                                <span>所属分类:</span>
                                <el-select v-model="filterData.model_v" clearable @change="f_selectChange"
                                           placeholder="全部" style="width: 400px">
                                    <el-option v-for="item in filterData.model_options" :key="item" :label="item"
                                               :value="item"></el-option>
                                </el-select>
                                <span>结果:</span>
                                <el-select v-model="filterData.status_v" clearable @change="f_selectChange"
                                           placeholder="全部">
                                    <el-option label="成功" value="passed"></el-option>
                                    <el-option label="失败" value="failed"></el-option>
                                    <el-option label="错误" value="error"></el-option>
                                    <el-option label="跳过" value="skipped"></el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="4" style="text-align: right">
                                <span style="color: #000000; font-size: 15px; text-shadow: 3px 5px 5px #7e7e7e;"><b>用例总数: {{tableData.length}}</b></span>
                            </el-col>
                        </el-row>
                    </template>
                    <el-table :data="tableData" ref="refTable" border style="width: 100%">
                        <el-table-column type="expand">
                            <template #default="scope">
                                <el-row class="row-expand">
                                    <el-col>
                                        <el-tabs type="border-card">
                                            <el-tab-pane label="打印内容" v-if="scope.row.print">
                                                <pre v-html="scope.row.print"></pre>
                                            </el-tab-pane>
                                            <el-tab-pane label="请求内容" v-if="scope.row.query">
                                                <pre v-html="scope.row.query"></pre>
                                            </el-tab-pane>
                                            <el-tab-pane label="响应头" v-if="scope.row.resp_headers">
                                                <pre v-html="scope.row.resp_headers"></pre>
                                            </el-tab-pane>
                                            <el-tab-pane label="响应内容" v-if="scope.row.response">
                                                <pre v-html="scope.row.response"></pre>
                                            </el-tab-pane>
                                            <el-tab-pane label="跳过说明" v-if="scope.row.skipped">
                                                <pre v-html="scope.row.skipped"></pre>
                                            </el-tab-pane>
                                            <el-tab-pane v-if="scope.row.msg_dict">
                                                <template #label>
                                                    <span style="background-color: #f6c3c6; padding: 2px 5px; border-radius: 3px">失败详情</span>
                                                </template>
                                                <el-tag style="margin: 0 0 5px 20px" type="danger"
                                                        v-if="scope.row.typed">{{f_errorInfo(scope.row.typed)}}
                                                </el-tag>
                                                <pre v-html="scope.row.msg_dict"></pre>
                                            </el-tab-pane>
                                            <el-tab-pane label="图片预览" v-if="scope.row.img">
                                                <el-image :src="scope.row.img" fit="contain" alt="图片"
                                                          @error="f_handleImageLoadError"></el-image>
                                                <span v-if="imgErrorText" style="color: #9d300b">{{imgErrorText}}</span>
                                            </el-tab-pane>
                                            <el-tab-pane v-if="scope.row.status_code" disabled>
                                                <template #label>
                                                    <span class="custom-tabs-label">
                                                        <el-tag :type="scope.row.status_code==200?'success':'danger'">{{scope.row.status_code}}</el-tag>
                                                    </span>
                                                </template>
                                            </el-tab-pane>
                                        </el-tabs>
                                    </el-col>
                                </el-row>
                            </template>
                        </el-table-column>
                        <el-table-column label="序号" type="index" width="80px"></el-table-column>
                        <el-table-column label="模块" prop="model" show-overflow-tooltip></el-table-column>
                        <el-table-column label="类" prop="classed" show-overflow-tooltip></el-table-column>
                        <el-table-column label="方法" prop="method" show-overflow-tooltip></el-table-column>
                        <el-table-column label="描述" prop="doc" show-overflow-tooltip></el-table-column>
                        <el-table-column label="响应时间" prop="duration" width="100px"></el-table-column>
                        <el-table-column label="结果" width="100px">
                            <template #default="scope">
                                <el-tag v-if="scope.row.status==='passed'" type="success">成功</el-tag>
                                <el-tag v-else-if="scope.row.status==='error'" type="warning">错误</el-tag>
                                <el-tag v-else-if="scope.row.status==='failed'" type="danger">失败</el-tag>
                                <el-tag v-else-if="scope.row.status==='skipped'" type="info">跳过</el-tag>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-card>
            </el-col>
        </el-row>
        <!-- 展开/折叠/top按钮 -->
        <div style="right: 40px; position: absolute; width:40px;">
            <el-affix position="bottom" :offset="150">
                <el-row>
                    <el-col style="margin-bottom: 20px;">
                        <el-button type="primary" plain circle size="large" @click="f_toggleRowExpansion(true)">+
                        </el-button>
                    </el-col>
                    <el-col>
                        <el-button type="primary" plain circle size="large" @click="f_toggleRowExpansion(false)">-
                        </el-button>
                    </el-col>
                </el-row>
            </el-affix>
        </div>
        <el-backtop target="#app .el-scrollbar__wrap"></el-backtop>
    </el-scrollbar>
</div>
<script>
    Object.assign(window, Vue)
    const App = {
        setup() {
            const tableData = ref([])
            const refTable = ref()
            const runRespTimeList = ref([])       // 折线图主数据（响应时间）
            const filterData = reactive({model_v: null, model_options: [], status_v: null,})
            const form = reactive({passed: 0, failed: 0, error: 0, skipped: 0})
            const sourceData = reactive(templateData)
            const imgErrorText = ref('')

            const setupInfo = () => {
                // 获取组列表
                sourceData.cases.map(el => {
                    if (filterData.model_options.indexOf(el['model']) === -1) {
                        filterData.model_options.push(el['model'])
                    }
                })
                f_selectChange()
            }

            const f_errorInfo = (typed) => {
                if (typed == 10) {
                    msg = "响应异常"
                } else if (typed == 11) {
                    msg = "断言类型错误"
                } else if (typed == 12) {
                    msg = "断言元素类型错误"
                } else if (typed == 13) {
                    msg = "断言元素key错误"
                } else if (typed == 14) {
                    msg = "响应内容不是json"
                } else if (typed == 15) {
                    msg = "断言type字段值错误"
                } else if (typed == 20) {
                    msg = "状态码错误"
                } else if (typed == 21) {
                    msg = "text匹配失败"
                } else if (typed == 22) {
                    msg = "json匹配失败"
                } else {
                    msg = null
                }
                return msg
            }


            // 下拉框过滤
            const f_selectChange = () => {
                tableData.value = sourceData.cases.filter(el => {
                    return (filterData.model_v || filterData.model_options).indexOf(el.model) !== -1 && (filterData.status_v || ["passed", "failed", "skipped", "error"]).indexOf(el.status) !== -1
                })
                form.passed = tableData.value.filter(el => {
                    return el.status === "passed"
                }).length
                form.failed = tableData.value.filter(el => {
                    return el.status === "failed"
                }).length
                form.error = tableData.value.filter(el => {
                    return el.status === "error"
                }).length
                form.skipped = tableData.value.filter(el => {
                    return el.status === "skipped"
                }).length
                // 响应时间列表
                runRespTimeList.value = []
                tableData.value.map(el => {
                    runRespTimeList.value.push(el.duration)
                })
                nextTick(() => {
                    chart1()
                    chart2()
                })
            }

            //展开或者折叠
            const f_toggleRowExpansion = (isExpansion) => {
                tableData.value.map(el => {
                    refTable.value.toggleRowExpansion(el, isExpansion)
                })
            }

            // 图片加载失败
            const f_handleImageLoadError = () => {
                imgErrorText.value = "图片加载失败"
            }

            // 饼图
            const chart1 = () => {
                let seriesData = [
                    {name: "成功", value: form.passed},
                    {name: "失败", value: form.failed},
                    {name: "错误", value: form.error},
                    {name: "跳过", value: form.skipped}
                ];
                // 加载图像
                let myChart = echarts.init(document.getElementById("echart1"));
                let option = {
                    title: {
                        text: '执行结果',
                        left: 'center'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        top: '150px'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    color: ['#0f9165', '#94303f', '#e6a23c', '#636363'],
                    series: [
                        {
                            type: 'pie',
                            name: '测试结果',
                            radius: ['45%', '70%'],
                            center: ['50%', '60%'],
                            data: seriesData,
                            zlevel: 1,
                            z: 1,
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '20',
                                    fontWeight: 'bold'
                                }
                            },
                        }
                    ]
                };
                myChart.setOption(option, true);
                window.addEventListener("resize", () => {
                    myChart.resize()
                })
            }

            // 折线图
            const chart2 = () => {
                let seriesData = runRespTimeList.value;
                let xAxisData = Array.from({length: seriesData.length}, (x, i) => i + 1);
                // 加载图像
                let myChart = echarts.init(document.getElementById("echart2"));
                let option = {
                    color: 'red',
                    title: [
                        {
                            left: 'center',
                            text: '响应时间'
                        },
                    ],
                    tooltip: {
                        trigger: 'axis',
                        formatter: '序号：{b}<br/>响应时间：{c}s'
                    },

                    xAxis:
                        {
                            data: xAxisData,
                        },
                    yAxis:
                        {},
                    grid: {
                        show: false,
                        bottom: '20px',
                    },
                    series: [
                        {
                            type: 'line',
                            name: '响应时间',
                            showSymbol: false,
                            data: seriesData,
                            zlevel: 1,
                            z: 1,
                        }
                    ]
                };
                myChart.setOption(option, true);
                window.addEventListener("resize", () => {
                    myChart.resize()
                })
            }

            setupInfo()

            return {
                sourceData,
                form,
                filterData,
                tableData,
                refTable,
                imgErrorText,
                f_selectChange,
                f_toggleRowExpansion,
                f_errorInfo,
                f_handleImageLoadError,
            }
        },
    }
    const app = Vue.createApp(App)
    app.use(ElementPlus)
    app.mount("#app")
</script>
</body>
</html>