import{ImageInspectorView}from"../../view/image.mjs";import{isEmpty,isEquivalent,waitFor,humanDuration}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{Controller}from"../base.mjs";const E=new ElementBuilder({invocationLoading:"enfugue-invocation-loading",invocationLoaded:"enfugue-invocation-loaded",invocationDuration:"enfugue-invocation-duration",invocationIterations:"enfugue-invocation-iterations",invocationRemaining:"enfugue-invocation-remaining",invocationSampleChooser:"enfugue-invocation-sample-chooser",invocationSample:"enfugue-invocation-sample",invocationStop:"enfugue-invocation-stop"});class InvocationController extends Controller{static truncatePromptLength=36;constructor(i){super(i),this.kwargs={}}get width(){return this.kwargs.width||this.application.config.model.invocation.width}set width(i){this.width!==i&&this.publish("engineWidthChange",i),this.kwargs.width=i}get height(){return this.kwargs.height||this.application.config.model.invocation.height}set height(i){this.height!==i&&this.publish("engineHeightChange",i),this.kwargs.height=i}get chunkingSize(){return this.kwargs.chunking_size||this.application.config.model.invocation.chunkingSize}set chunkingSize(i){this.chunkingSize!==i&&this.publish("engineChunkingSizeChange",i),this.kwargs.chunking_size=i}get chunkingBlur(){return this.kwargs.chunking_blur||this.application.config.model.invocation.chunkingBlur}set chunkingBlur(i){this.chunkingBlur!==i&&this.publish("engineChunkingBlurChange",i),this.kwargs.chunking_blur=i}get prompt(){return this.kwargs.prompt||""}set prompt(i){this.prompt!==i&&this.publish("enginePromptChange",i),this.kwargs.prompt=i}get negativePrompt(){return this.kwargs.negative_prompt||""}set negativePrompt(i){this.negativePrompt!==i&&this.publish("engineNegativePromptChange",i),this.kwargs.negative_prompt=i}get samples(){return this.kwargs.samples||1}set samples(i){this.samples!==i&&this.publish("engineSamplesChange",i),this.kwargs.samples=i}get seed(){return this.kwargs.seed}set seed(i){this.seed!==i&&this.publish("engineSeedChange",i),this.kwargs.seed=i}get guidanceScale(){return this.kwargs.guidance_scale||this.application.config.model.invocation.guidanceScale}set guidanceScale(i){this.guidanceScale!==i&&this.publish("engineGuidanceScaleChange",i),this.kwargs.guidance_scale=i}get inferenceSteps(){return this.kwargs.num_inference_steps||this.application.config.model.invocation.inferenceSteps}set inferenceSteps(i){this.inferenceSteps!==i&&this.publish("engineInferenceStepsChange",i),this.kwargs.num_inference_steps=i}get model(){return this.kwargs.model}set model(i){this.model!==i&&this.publish("engineModelChange",i),this.kwargs.model=i}get modelType(){return this.kwargs.model_type||"checkpoint"}set modelType(i){this.modelType!==i&&this.publish("engineModelTypeChange",i),this.kwargs.model_type=i}get outscale(){return this.kwargs.outscale||1}set outscale(i){this.outscale!==i&&this.publish("engineOutscaleChange",i),this.kwargs.outscale=parseInt(i)}get upscale(){return this.kwargs.upscale}set upscale(i){isEquivalent(this.upscale,i)||this.publish("engineUpscaleChange",i),this.kwargs.upscale=i}get upscaleIterative(){return!0===this.kwargs.upscale_iterative}set upscaleIterative(i){this.upscaleIterative!==i&&this.publish("engineUpscaleIterativeChange",i),this.kwargs.upscale_iterative=i}get upscaleDiffusion(){return!0===this.kwargs.upscale_diffusion}set upscaleDiffusion(i){this.upscaleDiffusion!==i&&this.publish("engineUpscaleDiffusionChange",i),this.kwargs.upscale_diffusion=i}get upscaleDiffusionPrompt(){return this.kwargs.upscale_diffusion_prompt}set upscaleDiffusionPrompt(i){isEquivalent(this.upscaleDiffusionPrompt,i)||this.publish("engineUpscaleDiffusionPromptChange",i),this.kwargs.upscale_diffusion_prompt=i}get upscaleDiffusionNegativePrompt(){return this.kwargs.upscale_diffusion_negative_prompt}set upscaleDiffusionNegativePrompt(i){isEquivalent(this.upscaleDiffusionNegativePrompt,i)||this.publish("engineUpscaleDiffusionNegativePromptChange",i),this.kwargs.upscale_diffusion_negative_prompt=i}get upscaleDiffusionSteps(){return this.kwargs.upscale_diffusion_steps||this.application.config.model.invocation.upscaleDiffusionSteps}set upscaleDiffusionSteps(i){isEquivalent(this.upscaleDiffusionSteps,i)||this.publish("engineUpscaleDiffusionStepsChange",i),this.kwargs.upscale_diffusion_steps=i}get upscaleDiffusionStrength(){return this.kwargs.upscale_diffusion_strength||this.application.config.model.invocation.upscaleDiffusionStrength}set upscaleDiffusionStrength(i){isEquivalent(this.upscaleDiffusionStrength,i)||this.publish("engineUpscaleDiffusionStrengthChange",i),this.kwargs.upscale_diffusion_strength=i}get upscaleDiffusionGuidanceScale(){return this.kwargs.upscale_diffusion_guidance_scale||this.application.config.model.invocation.upscaleDiffusionGuidanceScale}set upscaleDiffusionGuidanceScale(i){isEquivalent(this.upscaleDiffusionGuidanceScale,i)||this.publish("engineUpscaleDiffusionGuidanceScaleChange",i),this.kwargs.upscale_diffusion_guidance_scale=i}get upscaleDiffusionChunkingSize(){return this.kwargs.upscale_diffusion_chunking_size||this.application.config.model.invocation.upscaleDiffusionChunkingSize}set upscaleDiffusionChunkingSize(i){this.upscaleDiffusionChunkingSize!==i&&this.publish("engineUpscaleDiffusionChunkingSizeChange",i),this.kwargs.upscale_diffusion_chunking_size=i}get upscaleDiffusionChunkingBlur(){return this.kwargs.upscale_diffusion_chunking_blur||this.application.config.model.invocation.upscaleDiffusionChunkingBlur}set upscaleDiffusionChunkingBlur(i){this.upscaleDiffusionChunkingBlur!==i&&this.publish("engineUpscaleDiffusionChunkingBlurChange",i),this.kwargs.upscale_diffusion_chunking_blur=i}get upscaleDiffusionScaleChunkingSize(){return!1!==this.kwargs.upscale_diffusion_scale_chunking_size}set upscaleDiffusionScaleChunkingSize(i){this.upscaleDiffusionScaleChunkingSize!==i&&this.publish("engineUpscaleDiffusionScaleChunkingSizeChange",i),this.kwargs.upscale_diffusion_scale_chunking_size=i}get upscaleDiffusionScaleChunkingBlur(){return!1!==this.kwargs.upscale_diffusion_scale_chunking_blur}set upscaleDiffusionScaleChunkingBlur(i){this.upscaleDiffusionScaleChunkingBlur!==i&&this.publish("engineUpscaleDiffusionScaleChunkingBlurChange",i),this.kwargs.upscale_diffusion_scale_chunking_blur=i}get upscaleDiffusionControlnet(){return this.kwargs.upscale_diffusion_controlnet||null}set upscaleDiffusionControlnet(i){isEquivalent(this.upscaleDiffusionControlnet,i)||this.publish("engineUpscaleDiffusionControlnetChange",i),this.kwargs.upscale_diffusion_controlnet=i}get inversion(){return this.kwargs.inversion||[]}set inversion(i){isEquivalent(this.inversion,i)||this.publish("engineInversionChange",i),this.kwargs.inversion=i}get lora(){return this.kwargs.lora||[]}set lora(i){isEquivalent(this.lora,i)||this.publish("engineLoraChange",i),this.kwargs.lora=i}async initialize(){this.loadingBar=E.invocationLoading().content(E.invocationLoaded().addClass("sliding-gradient"),E.invocationDuration(),E.invocationIterations(),E.invocationRemaining().hide()),this.invocationSampleChooser=E.invocationSampleChooser().hide(),this.invocationStop=E.invocationStop().content("Stop").on("click",(()=>{this.stopInvocation()})),(await this.images.getNode()).append(this.loadingBar).append(this.invocationSampleChooser).append(this.invocationStop)}hideSampleChooser(){this.invocationSampleChooser.hide()}async invoke(i,e=!1){i=isEmpty(i)?{}:i;let t={...this.kwargs,...i};if(isEmpty(t.prompt))return void this.notify("Error","Missing Prompt","A prompt is required.");let n=await this.application.model.post("invoke",null,null,t);if(this.invocationStop.addClass("ready"),!isEmpty(n.uuid))if(e){let i=t.prompt.substring(0,this.constructor.truncatePromptLength);i.length===this.constructor.truncatePromptLength&&(i+="..."),await this.startDetachedInvocationMonitor(i,n.uuid,parseInt(t.width)||512,parseInt(t.height)||512)}else await this.canvasInvocation(n.uuid),this.invocationStop.removeClass("ready")}async stopInvocation(){if(this.invocationStop.hasClass("ready"))try{await this.application.model.post("/invocation/stop"),this.invocationStop.removeClass("ready"),this.notify("info","Stopped","Successfully stopped engine.")}catch(i){let e=`${i}`;isEmpty(i.detail)?isEmpty(i.title)||(e=i.title):e=i.detail,this.notify("error","Error",`Received an error when stopping. The engine may still be stopped, wait a moment and check again. ${e}`)}}async monitorInvocation(i,e,t,n){const s=this.application.config.model.invocation.interval||1e3,a=this.application.config.model.queue.interval||5e3,o=this.application.config.model.invocation.errors.consecutive||2;void 0===e&&(e=()=>{}),void 0===t&&(t=()=>{}),void 0===n&&(n=()=>{});let r,u,l,h,c,p,g=(new Date).getTime(),f=i=>"queued"===i.status?a:Math.min(Math.max(s,(()=>{let i=r/(c-g),e=isEmpty(l)?i:l/1e3,t=(u-r)/(.75*e+.25*i)-((new Date).getTime()-c);return isNaN(t)&&(t=1/0),n(t,r,u,l,h),t})()/2),a),m=async()=>{let n,s;for(let e=0;e<o;e++)try{n=await this.application.model.get(`/invocation/${i}`)}catch(i){s=i}if(isEmpty(n))return this.notify("error","Invocation Error",`${o} consecutive errors were detected communicating with the server. Please check the server logs. The last error was: ${s}`),void t();if(n.total!==u&&(isEmpty(u)||(g=(new Date).getTime()),u=n.total),n.step!==r&&(r=n.step,c=(new Date).getTime()),n.rate!==l&&(l=n.rate),h=n.duration,!isEmpty(n.images)){let i=n.images.map((i=>`/api/invocation/${i}`)),t="completed"===n.status;e(i,t)}if("error"===n.status)return this.notify("error","Invocation Failed",n.message),void t();"completed"!==n.status&&(p=setTimeout(m,f(n)))};m()}async canvasInvocation(i){let e,t,n,s,a,o,r,u,l,h,c=!1,p=!1,g=(new Date).getTime(),f=g,m=g,d=g,v=0,w=[],k=this.loadingBar.find(E.getCustomTag("invocationLoaded")),C=this.loadingBar.find(E.getCustomTag("invocationDuration")),S=this.loadingBar.find(E.getCustomTag("invocationIterations")),_=this.loadingBar.find(E.getCustomTag("invocationRemaining")),D=()=>{if(isEmpty(o))this.invocationSampleChooser.hide();else if(0===w.length){this.images.setCurrentInvocationImage(o[0]),this.invocationSampleChooser.empty().append(E.invocationSample().class("no-sample").content("×").on("click",(()=>{v=null,this.images.hideCurrentInvocation()})));for(let i in o){let e=E.img().src(o[i]);w.push(e),this.invocationSampleChooser.append(E.invocationSample().content(e).on("click",(()=>{this.images.setCurrentInvocationImage(e.src()),v=i})))}this.invocationSampleChooser.show().render()}else{for(let i in o)w[i].src(o[i]);null!==v&&this.images.setCurrentInvocationImage(o[v])}},y=()=>{let i=(new Date).getTime();if(p)s<100&&s>0?s+=1:(s=100,c=!0);else if(!isEmpty(t)&&t<1/0){let o=i-m,r=t-(i-n),u=o+r;a=r,e=u,s=o/u*100}f=i,(()=>{let i=f-g;if(C.content(humanDuration(i/1e3)),isEmpty(s))k.css("width","100%"),S.hide(),_.show().content("Initializing…");else if(s<100){_.show().content(humanDuration(a/1e3)),k.css("width",`${s.toFixed(2)}%`);let i=l,e="it/s";!isEmpty(i)&&i<1/0?(i<1&&(i=1/i,e="s/it"),S.show().content(`Iteration ${r}/${u} (${i.toFixed(2)} ${e})`)):S.show().content(`Iteration ${r}/${u}`)}else if(c||isEmpty(h))k.css("width","0"),_.empty().hide();else{_.content("Finalizing step…");let i=u/h,e="it/s";i<1&&(i=1/i,e="s/it"),S.content(`${u} Iterations at ${i.toFixed(2)} ${e}`),k.css("width","100%")}})(),c||requestAnimationFrame((()=>y()))};this.loadingBar.addClass("loading"),this.images.hideCurrentInvocation(),this.invocationSampleChooser.empty(),window.requestAnimationFrame((()=>y())),this.monitorInvocation(i,(async(i,e)=>{p=e,i.length>0&&(o=i,D())}),(()=>{p=!0,c=!0,_.empty().hide(),S.empty().hide()}),((i,e,a,o,c)=>{t=i,r!==e&&(d=n),r=e,l=o,h=c,n=(new Date).getTime(),u!==a&&(m=n,isEmpty(u)||(r=0,s=null,d=n)),u=a})),await waitFor((()=>c)),this.loadingBar.removeClass("loading")}async startDetachedInvocationMonitor(i,e,t,n){let s=!1,a=[],o=[];this.monitorInvocation(e,(async(r,u,l)=>{s=!0;for(let s in r){let u=r[s];if(a.length<=s){let r=new ImageInspectorView(this.application.config,u,e),l=await this.spawnWindow(`${i}, sample ${s+1}`,r,t+30,n+90);r.loading(),a.push(l),o.push(r)}else o[s].setImage(u),a[s].setName(`${i}, ${l} elapsed, sample ${s+1}`)}if(u)for(let e in a)a[e].setName(`${i} complete in ${l}, sample ${e+1}`),o[e].doneLoading()}),(()=>s=!0)),await waitFor((()=>!0===s))}}export{InvocationController};
